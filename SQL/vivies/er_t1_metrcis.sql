WITH RANKING_TABLE AS (
    SELECT ER.FULL_NAME
         , ER.EMPLOYEE_ID
         , ER.EFFECTIVENESS
         , ER.EFFICIENCY
         , ER.QUALITY
         , POW(PERCENT_RANK() OVER (ORDER BY NVL(ER.EFFECTIVENESS, 0)), 1) AS EFFECTIVENESS_RANK
         , rank() OVER (ORDER BY NVL(ER.EFFECTIVENESS, 0) DESC) AS EFFECTIVENESS_INT_RANK
         , POW(PERCENT_RANK() OVER (ORDER BY ER.EFFICIENCY DESC), 1)       AS EFFICIENCY_RANK
         , rank() OVER (ORDER BY ER.EFFICIENCY ) AS EFFICIENCY_INT_RANK
         , POW(PERCENT_RANK() OVER (ORDER BY NVL(ER.QUALITY, 0)), 1)       AS QUALITY_RANK
         , rank() OVER (ORDER BY NVL(ER.QUALITY, 0) DESC) AS QUALITY_INT_RANK
         , (EFFECTIVENESS_RANK + EFFICIENCY_RANK + QUALITY_RANK) / 3       AS WEIGHTED_RANK
    FROM D_POST_INSTALL.V_CX_KPIS_ER_T1 AS ER
)

   , MAIN AS (
    SELECT *
    FROM RANKING_TABLE
    ORDER BY WEIGHTED_RANK DESC
    LIMIT 5
)

   , TEST_CTE AS (
    SELECT *
    FROM RANKING_TABLE
)

SELECT *
FROM TEST_CTE
