WITH PROCESS_START AS (
    SELECT F.*
    FROM D_POST_INSTALL.V_FILINGS_BATCH_ACCOUNT_LIST AS F
)

   , PROCESS_END AS (
    SELECT U.*
         , 1 AS SUCCESSFUL_UPLOAD
    FROM D_POST_INSTALL.V_FILINGS_BATCH_UPLOADS AS U
)

   , MAIN AS (
    SELECT S.*
         , TF.BATCH_END
         , TF.BATCH_START
         , E.DAY_UPLOADED
         , E.SUCCESSFUL_UPLOAD
         , CURRENT_DATE AS LAST_REFRESHED
    FROM PROCESS_START AS S
             LEFT OUTER JOIN D_POST_INSTALL.V_FILINGS_BATCH_TIMEFRAME_DETAILS AS TF
                             ON TF.BATCH_NUMBER = S.WEEK_BATCH
             LEFT OUTER JOIN PROCESS_END AS E
                             ON S.PROJECT_ID = E.PROJECT_ID
)

   , TEST_VIEW AS (
    SELECT DATE_TRUNC('MM', BATCH_START) AS MONTH
         , COUNT(*)                      AS CT
         , SUM(SUCCESSFUL_UPLOAD)        AS UPLOADED
    FROM MAIN
    GROUP BY MONTH
    ORDER BY MONTH DESC
)

SELECT *
FROM MAIN;