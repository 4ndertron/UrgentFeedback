WITH PROCESS_START AS (
    SELECT F.*
         , TO_DATE(DATEADD(d, F.WEEK_BATCH * 7, '2013-11-06')) AS BATCH_DATE
    FROM D_POST_INSTALL.V_FILINGS_BATCH_ACCOUNT_LIST AS F
)

   , PROCESS_END AS (
    SELECT U.*
    FROM D_POST_INSTALL.V_FILINGS_BATCH_UPLOADS AS U
)

   , MAIN AS (
    SELECT S.*
         , TF.BATCH_START
         , TF.BATCH_END
         , E.DAY_UPLOADED
         , CURRENT_DATE AS LAST_REFRESHED
    FROM PROCESS_START AS S
             LEFT OUTER JOIN D_POST_INSTALL.V_FILINGS_BATCH_TIMEFRAME_DETAILS AS TF
                             ON TF.BATCH_NUMBER = S.WEEK_BATCH
             LEFT OUTER JOIN PROCESS_END AS E
                             ON (E.SERVICE_NUMBER = REGEXP_SUBSTR(S.PROJECT_NAME, '\\d+', 1, 1, 'e') OR
                                 E.SERVICE_NUMBER = REGEXP_SUBSTR(S.SERVICE_NAME, '\\d+', 1, 1, 'e')) AND
                                E.DAY_UPLOADED >= TF.BATCH_START
)

   , TEST_VIEW AS (
    SELECT WEEK_BATCH
         , COUNT(SERVICE_NAME) TOTAL_ACCOUNTS
         , COUNT(DAY_UPLOADED) UNIQUE_ACCOUNTS
    FROM MAIN
    GROUP BY WEEK_BATCH
    ORDER BY WEEK_BATCH DESC
)

SELECT *
FROM MAIN